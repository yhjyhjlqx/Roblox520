name: Create Roblox520 Release

on:
  push:
    tags: ['v*']  # ä»…å½“æ¨é€vå¼€å¤´çš„tagæ—¶è§¦å‘
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-release:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      # ç¬¬ä¸€æ­¥ï¼šæ£€å‡ºä»£ç ï¼ˆå¿…é¡»æœ€å…ˆæ‰§è¡Œï¼‰
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # è·å–å®Œæ•´gitå†å²
          ref: ${{ github.ref || 'main' }}

      # ç¬¬äºŒæ­¥ï¼šæ‰‹åŠ¨è§¦å‘æ—¶åˆ›å»ºä¸´æ—¶tag
      - name: Create temp tag (if manual run)
        if: github.event_name == 'workflow_dispatch' && !contains(github.ref, 'tags/')
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          TAG_NAME="v0.0.0-manual-${{ github.run_id }}"
          git tag -a "$TAG_NAME" -m "Temporary tag for manual trigger"
          git push origin "$TAG_NAME"
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV
          echo "Created temp tag: $TAG_NAME"

      # ç¬¬ä¸‰æ­¥ï¼šå‡†å¤‡Robloxä¸“ç”¨å‘å¸ƒåŒ…
      - name: Prepare Roblox520 package
        run: |
          # åˆ›å»ºç›®å½•ç»“æ„
          mkdir -p release_package/
          
          # å¤åˆ¶å¿…è¦æ–‡ä»¶ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
          cp -f hosts release_package/ || echo "âš ï¸ hosts file missing"
          [ -f scripts/windows_update.ps1 ] && cp scripts/windows_update.ps1 release_package/
          [ -f scripts/macos_update.sh ] && cp scripts/macos_update.sh release_package/
          [ -f scripts/linux_update.sh ] && cp scripts/linux_update.sh release_package/
          
          # æ·»åŠ Robloxä¸“ç”¨è¯´æ˜æ–‡ä»¶
          echo "Roblox520 - ä¼˜åŒ–Robloxå›½é™…ç‰ˆè®¿é—®" > release_package/README.txt
          echo "æ›´æ–°æ—¥æœŸ: $(date)" >> release_package/README.txt
          
          # æ‰“åŒ…å¹¶éªŒè¯
          zip -r Roblox520_Scripts.zip release_package/
          unzip -l Roblox520_Scripts.zip
          echo "::notice:: Roblox520 package ready"

      # ç¬¬å››æ­¥ï¼šå‘å¸ƒåˆ°GitHub Releases
      - name: Publish Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            Roblox520_Scripts.zip
          tag_name: ${{ github.ref_name || env.TAG_NAME || 'v0.0.0-fallback' }}
          name: Roblox520 ${{ github.ref_name || 'Manual Release' }}
          body: |
            ### ğŸ® Roblox520 ä¸“ç”¨å‘å¸ƒåŒ…

            **åŠŸèƒ½ï¼š**
            - è§£é™¤Robloxå›½é™…ç‰ˆè®¿é—®é™åˆ¶
            - é˜²æ­¢é‡å®šå‘åˆ°è…¾è®¯ç½—å¸ƒä¹æ€
            - è‡ªåŠ¨æ›´æ–°æœåŠ¡å™¨åŸŸå

            **åŒ…å«æ–‡ä»¶ï¼š**
            - Windowsè„šæœ¬: `windows_update.ps1`
            - macOSè„šæœ¬: `macos_update.sh` 
            - Linuxè„šæœ¬: `linux_update.sh`
            - æœ€æ–°Hostsæ–‡ä»¶: `hosts`

            **ä½¿ç”¨æŒ‡å—ï¼š**
            1. ä¸‹è½½ZIPåŒ…å¹¶è§£å‹
            2. å³é”®è¿è¡Œå¯¹åº”å¹³å°è„šæœ¬
            3. é‡åˆ°é—®é¢˜è¯·æäº¤[Issue](https://github.com/yhjyhjlqx/Roblox520/issues)
          draft: false
          prerelease: ${{ !github.ref_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ç¬¬äº”æ­¥ï¼šåç½®æ£€æŸ¥
      - name: Verify release
        if: always()
        run: |
          echo "::group::å·¥ä½œç›®å½•ç»“æ„"
          ls -R
          echo "::endgroup::"
          echo "âœ… Roblox520å‘å¸ƒæµç¨‹å®Œæˆ"
